name: Deploy to GitHub Pages

on:
  push:
    branches: ['main']
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Debug - Show source structure
        run: |
          echo "=== Source Structure ==="
          find . -type f -name "*.html" -o -name "*.js" -o -name "*.css" | grep -v node_modules | sort
          echo "=== src folder contents ==="
          ls -la src/ && find src/ -type f | sort || echo "No src directory"
          echo "=== static folder contents ==="
          ls -la static/ && find static/ -type f | sort || echo "No static directory"
        
      - name: Build project
        run: npm run build
        
      - name: Verify build output
        run: |
          echo "=== Build Output ==="
          if [ -d "dist" ]; then
            echo "Dist folder structure:"
            find dist -type f | sort
            echo ""
            echo "Dist folder size:"
            du -sh dist/*
          else
            echo "‚ùå No dist folder created!"
            echo "Creating manual dist folder from src..."
            mkdir -p dist
            if [ -d "src" ]; then
              # Use rsync for better copying (preserves structure)
              rsync -av src/ dist/ --exclude="*.js" --exclude="*.ts" --exclude="*.css" --exclude="*.scss" || true
            fi
            if [ -d "static" ]; then
              rsync -av static/ dist/ || true
            fi
            echo "Manual dist contents:"
            find dist -type f | sort
          fi
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
